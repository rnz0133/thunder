<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thunder</title>
    <style>
         #notifyModal { 
    z-index: 5000 !important; 
}
        :root { --bg: ; --white: #ffffff; --green: #28a745; --blue: #1a73e8; --purple: #6f42c1; --radius: 5px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; outline: none; }
        body { margin: 0; background: var(--bg); display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }

        /* Loader */
        #loader { display: none; position: fixed; inset: 0; backdrop-filter: blur(10px); background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff3; border-top: 4px solid #fff; border-radius: 50%; animation: spin 0.6s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .app-container { padding: 12px; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        .card { background: white; border-radius: var(--radius); padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Grid & Card Style */
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .photo-card { background: #fff; border-radius: 5px; overflow: hidden; box-shadow: 0 9px 10px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column; border: 2px solid #ffffff;}
        
        /* Khung ·∫£nh 1/1 chu·∫©n */
        .photo-wrapper { position: relative; width: 100%; aspect-ratio: 1/1; background: #000; overflow: hidden;}
        .photo-wrapper img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; pointer-events: none; user-select: none; -webkit-user-drag: none;}
        
        /* Hi·ªáu ·ª©ng l√†m m·ªù */
        .img-blur-shop { filter: blur(15px) brightness(0.7); }
        .img-blur-inv { filter: blur(12px) brightness(0.6); }

        .tap-label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.0); pointer-events: none; z-index: 2; }

        /* N√∫t b·∫•m gi·ªØ nguy√™n style c·ªßa b·∫°n */
        .buy-btn { background: linear-gradient(135deg, #50b7ca, #50b7ca); color: white; border: none; width: 100%; padding: 14px; font-weight: 800; font-size: 11px; cursor: pointer; margin: 0;border-radius: 0; }
        .btn-action { border: none; border-radius: var(--radius); color: white; font-weight: bold; cursor: pointer; font-size: 11px; padding: 12px; text-align: center; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 20px 0; }
        .page-btn { background: white; color: var(--bg); border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { color: white; font-weight: bold; font-size: 14px; }

        .tabs { display: flex; background: rgba(0,0,0,0.3); border-radius: var(--radius); padding: 4px; gap: 4px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; font-weight: bold; border-radius: 8px; color: white; cursor: pointer; }
        .tab-btn.active { background: white; color: var(--bg); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 25px; border-radius: var(--radius); width: 100%; max-width: 320px; position: relative; animation: modalPop 0.3s; }
        @keyframes modalPop { from { transform: scale(0.8); } to { transform: scale(1); } }
        .close-x { position: absolute; top: 10px; right: 15px; font-size: 20px; font-weight: bold; color: #ccc; cursor: pointer; }
        
        .input-style { width: 100%; padding: 14px; margin-bottom: 12px; border: 2px solid #eee; border-radius: var(--radius); }
        
        /* Receipt Style */
        .receipt-card { background:#fffff; padding: 20px; border-radius: 0 !important; font-family: monospace !important; border-top: 5px solid #000; position: relative; }
        .receipt-card * { font-family: monospace !important; border-radius: 0 !important; }
        .receipt-line { border-top: 1px dashed #000; margin: 10px 0; }
        .receipt-footer { font-size: 9px; color: #888; text-align: center; margin-top: 20px; }

        .price-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; }
        .price-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        .price-table b { color: var(--bg); }

        .app-footer { background: #000; padding: 30px 20px; text-align: center; margin-top: auto; border-top: 6px solid #ff2b4a rgba(290, 100, 57, 1.5); }
        .footer-logo { color: #fff; font-weight: 900; font-size: 16px; margin-bottom: 15px; letter-spacing: 2px; }
        .footer-support { color: #bbb; font-size: 12px; margin-bottom: 25px; display: block; text-decoration: none; }
        .footer-support b { color:#0096ff; }
        .copyright { color: #555; font-size: 10px; letter-spacing: 1px; margin-top: 10px; border-top: 1px solid #222; padding-top: 15px; }
        body {
    margin: 0;
    padding: 0;
    width: 100%;
    min-height: 100vh;
    
    /* C·ªë ƒë·ªãnh n·ªÅn, kh√¥ng cho n√≥ ƒë·∫©y khung web */
    background-image: url('https://i.supaimg.com/cd346a16-e332-4bcb-85b0-5535e99a0fb9.jpg');
    background-attachment: fixed; /* C·ªë ƒë·ªãnh n·ªÅn khi cu·ªôn */
    background-position: center;  /* CƒÉn gi·ªØa ·∫£nh */
    background-repeat: no-repeat;
    background-size: cover;       /* √âp ·∫£nh ph·ªß k√≠n nh∆∞ng kh√¥ng l√†m gi√£n khung */
    
    /* Ch·∫∑n m·ªçi h√†nh vi t·ª± ph√≥ng to c·ªßa tr√¨nh duy·ªát */
    touch-action: manipulation;
}

/* ƒê·∫£m b·∫£o khung ch·ª©a ch√≠nh lu√¥n chi·∫øm ƒë·ªß chi·ªÅu r·ªông */
#app-container, .main-content {
    width: 100%;
    max-width: 500px; /* Gi·ªõi h·∫°n ƒë·ªô r·ªông chu·∫©n di ƒë·ªông */
    margin: 0 auto;
    position: relative;
    z-index: 1;
}
#profileModal .modal-content {
    width: 80%;            /* R·ªông 80% m√†n h√¨nh ƒëi·ªán tho·∫°i */
    max-width: 300px;      /* Kh√¥ng qu√° 300px ƒë·ªÉ gi·ªØ d√°ng ƒë·∫πp */
    padding: 30px 15px;    /* Kho·∫£ng c√°ch b√™n trong r·ªông r√£i */
    display: flex;         /* K√≠ch ho·∫°t ch·∫ø ƒë·ªô x·∫øp h√†ng */
    flex-direction: column;/* X·∫øp c√°c th√†nh ph·∫ßn theo h√†ng d·ªçc */
    align-items: center;   /* CƒÉn gi·ªØa t·∫•t c·∫£ ·∫£nh v√† ch·ªØ */
    background: white;     /* N·ªÅn tr·∫Øng s·∫°ch s·∫Ω */
    border-radius: 5px;   /* Bo g√≥c cho m·ªÅm m·∫°i */
}

/* Ch·ªânh l·∫°i ·∫£nh trong Profile cho c√¢n ƒë·ªëi */
#p-avt {
    width: 70px !important;
    height: 70px !important;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
    border: 3px solid #ec6025; /* Vi·ªÅn cam cho n·ªïi b·∫≠t */
}

    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div id="loader-text">ƒêang t·∫£i...</div></div>

<div class="app-container">
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div onclick="checkAuthAndAction(() => openModal('profileModal'))" style="display:flex; align-items:center; cursor:pointer;">
            <img id="u-avt" src="https://i.supaimg.com/8d8e4ed8-68cf-4953-91af-ccf19f555441.jpg" style="width:45px; height:45px; border-radius:50%; object-fit:cover; border: 2px solid var(--bg);">
            
            <div style="margin-left:12px">
                <div id="u-name" style="font-weight:800; font-size:15px;">Kh√°ch</div>
                <div id="u-uid-small" style="font-size:10px; color:#999;">ID: ---</div>
                <div id="u-coins-txt" style="color:#f39c12; font-weight:bold; font-size:13px;">ü™ô 0</div>
            </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="btn-action" style="background:var(--green); min-width:85px; padding:6px;" onclick="checkAuthAndAction(renderCheckin)">ƒêI·ªÇM DANHüìÖ</button>
            <button class="btn-action" style="background:#ff2b4a; min-width:85px; padding:6px;" onclick="checkAuthAndAction(() => openModal('giftcodeModal'))">nh·∫≠n xu ü™ô</button>
        </div>
    </div>

    <div class="tabs">
        <button id="t-shop" class="tab-btn active" onclick="switchTab('shop')">TRANG CH·ª¶</button>
        <button id="t-inv" class="tab-btn" onclick="checkAuthAndAction(() => switchTab('inv'))">KHO ·∫¢NH</button>
    </div>

    <div id="main-view">
        <div id="photo-grid" class="photo-grid"></div>
        <div class="pagination">
            <button id="prevBtn" class="page-btn" onclick="changePage(-1)">Tr∆∞·ªõc</button>
            <span id="pageInfo" class="page-info">Trang 1</span>
            <button id="nextBtn" class="page-btn" onclick="changePage(1)">Sau</button>
        </div>
    </div>
</div>

<div id="giftcodeModal" class="modal">
    <div class="modal-content">
        <span class="close-x" onclick="closeModal('giftcodeModal')">&times;</span>
        <h3 style="text-align:center; color:#0d9721">ch√∫ √Ω</h3>
        <table class="price-table">
            <tr><td>nh·∫Øn tin ƒë·ªÉ nh·∫≠n m√£ xu</td><td align="right"><b></b>ü™ôü™ôüëá</td></tr>
        </table>        
        <button class="btn-action" style="background:#ff2b4a; width:100%; margin-bottom:15px;" onclick="window.open('https://www.tiktok.com/@tng.2104?_r=1&_t=ZS-937FBQ2XBFX', '_blank')">b·∫•m  v√†o ƒë√¢y ƒë·ªÉ inbox ‚ú® 
        </button>
        <div style="border-top: 1px solid #eee; padding-top:10px">
            <input type="text" id="gc-input" class="input-style" placeholder="Nh·∫≠p m√£ xu...">
            <button class="btn-action" style="background:#0096ff;width:100%" onclick="redeemGift()">X√ÅC NH·∫¨N</button>
        </div>
    </div>
</div>

<div id="receiptModal" class="modal"><div class="modal-content receipt-card"><h2 style="text-align:center;margin:0">bi√™n nh·∫≠n</h2><p style="text-align:center;font-size:8px">¬©2026 thunder all rights reserved</p><div class="receipt-line"></div><p><b>ID:</b> <span id="rec-uid">---</span></p><p><b>Ng∆∞·ªùi d√πng:</b> <span id="rec-name">---</span></p><p><b>Th·ªùi gian:</b> <span id="rec-date">---</span></p><div class="receipt-line"></div><p style="font-size:18px; text-align:center;"><b><span id="rec-coins">0</span> ü™ô</b></p><div class="receipt-line"></div><p class="receipt-footer">C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª• c·ªßa Thunder</p><button class="btn-action" style="background:#000; width:100%; margin-top:10px;" onclick="closeModal('receiptModal')">ƒê√ìNG</button></div></div>
<div id="notifyModal" class="modal"><div class="modal-content"><h3 id="notify-title" style="text-align:center; margin-top:0; color:var(--bg)">TH√îNG B√ÅO</h3><p id="notify-msg"></p><button id="notify-ok" class="btn-action" style="background:#0096ff; width:100%" onclick="closeModal('notifyModal')">ƒê√É HI·ªÇU</button></div></div>
<div id="authModal" class="modal"><div class="modal-content"><span class="close-x" onclick="closeModal('authModal')">&times;</span><h3 style="color:var(--bg);text-align:center;margin-top:0">ƒêƒÇNG NH·∫¨P</h3><input type="text" id="login-user" class="input-style" placeholder="T√™n t√†i kho·∫£n"><input type="password" id="login-pass" class="input-style" placeholder="M·∫≠t kh·∫©u"><button class="btn-action" style="background:var(--blue);width:100%" onclick="handleAuth('login')">ƒêƒÇNG NH·∫¨P</button><p style="text-align:center;font-size:12px;margin-top:15px">Ch∆∞a c√≥ t√†i kho·∫£n? <b style="color:var(--bg);cursor:pointer" onclick="closeModal('authModal');openModal('regModal')">ƒêƒÉng k√Ω</b></p></div></div>
<div id="regModal" class="modal"><div class="modal-content"><span class="close-x" onclick="closeModal('regModal')">&times;</span><h3 style="color:var(--green);text-align:center;margin-top:0">ƒêƒÇNG K√ù</h3><input type="text" id="reg-user" class="input-style" placeholder="T√™n t√†i kho·∫£n m·ªõi"><input type="password" id="reg-pass" class="input-style" placeholder="M·∫≠t kh·∫©u m·ªõi"><button class="btn-action" style="background:var(--green);width:100%" onclick="handleAuth('reg')">T·∫†O T√ÄI KHO·∫¢N M·ªöI</button></div></div>
<div id="profileModal" class="modal">
    <div class="modal-content">
        <span class="close-x" onclick="closeModal('profileModal')" style="top: 5px; right: 10px;">&times;</span>
        
        <img id="p-avt" src="https://i.supaimg.com/8d8e4ed8-68cf-4953-91af-ccf19f555441.jpg">
        
        <h3 id="p-name" style="margin: 5px 0; color: #333; font-size: 18px;">---</h3>
        
        <p id="p-uid" style="color: #999; font-size: 13px; margin: 0 0 20px 0;">---</p>
        
        <button class="btn-action" style="background:#e74c3c; width:100%; padding: 12px;" onclick="logout()">ƒêƒÇNG XU·∫§T</button>
    </div>
</div>

<div id="checkinModal" class="modal"><div class="modal-content"><span class="close-x" onclick="closeModal('checkinModal')">&times;</span><h3>üìÖ ƒêI·ªÇM DANH</h3><div id="checkin-list"></div></div></div>
<div id="viewPhotoModal" class="modal" onclick="closeModal('viewPhotoModal')">
    <div class="modal-content" style="background:none; box-shadow:none; padding00; width:100%;">
        <span class="close-x" style="color:#fff; right:0; top:-35px;" onclick="closeModal('viewPhotoModal')">&times;</span>
        
        <div id="viewPhotoBody"></div>
    </div>
</div>

<div id="confirmSellModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 style="color:#0096ff; margin-top:0;">X√ÅC NH·∫¨N B√ÅN</h3>
        <p id="sell-msg" style="font-size:14px; color:#555;"></p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-action" style="background:#ccc; flex:1;" onclick="closeModal('confirmSellModal')">H·ª¶Y</button>
            <button id="btn-confirm-final" class="btn-action" style="background:#ff2b4a; flex:1;">ƒê·ªíNG √ù</button>
        </div>
    </div>
</div>

<div id="giftModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <span class="close-x" onclick="closeModal('giftModal')">&times;</span>
        <h3 style="color:#8ebc45; margin-top:0;">T·∫∑ng ·∫£nh</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px;">Nh·∫≠p ch√≠nh x√°c ID ng∆∞·ªùi nh·∫≠n b√™n d∆∞·ªõi</p>
        <input type="text" id="gift-tid" class="input-style" placeholder="nh·∫≠p t·∫°i ƒë√¢y...">
        <button id="btn-gift-final" class="btn-action" style="background:#0096ff; width:100%; margin-top:10px;">G·ª¨I QU√Ä NGAY</button>
    </div>
</div>

<footer class="app-footer">
    <div class="footer-logo">THUNDER</div>
    <a href="mailto:caubengaytho73@gmail.com?subject=y√™u c·∫ßu h·ªó tr·ª£" class="footer-support">H·ªó tr·ª£ : <b>caubengaytho73@gmail.comüëà</b></a>
    <div class="copyright">¬© 2026 THUNDER . ALL RIGHTS RESERVED.</div>
</footer>

<script>
    const DB_URL = "https://hello-2c328-default-rtdb.asia-southeast1.firebasedatabase.app";
    const API_IMG = "https://raw.githubusercontent.com/rnz0133/thunder/refs/heads/main/image.json";

    let IMAGES = [], state = JSON.parse(localStorage.getItem('thunder_user')) || null;
    let currentPage = 1, itemsPerPage = 6, currentTab = 'shop';

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function myNotify(msg, title = "TH√îNG B√ÅO") { document.getElementById('notify-title').innerText = title; document.getElementById('notify-msg').innerText = msg; openModal('notifyModal'); }

    async function init() {
    showLoading(true);
    try {
        const r = await fetch(API_IMG);
        IMAGES = await r.json();
        
        // --- T·∫¢I N·ªÄN TH√îNG MINH ---
        // ∆Øu ti√™n t·∫£i tr∆∞·ªõc 6 ·∫£nh ƒë·∫ßu ti√™n c·ª±c nhanh
        IMAGES.slice(0, 6).forEach(p => {
            const img = new Image();
            img.src = p.url;
        });

        // C√°c ·∫£nh c√≤n l·∫°i s·∫Ω t·ª± ƒë·ªông t·∫£i khi ng∆∞·ªùi d√πng cu·ªôn t·ªõi (Lazy Load)
        // --------------------------

        IMAGES.sort(() => Math.random() - 0.5);
        if(state) await syncData();
        updateUI(); 
        renderGrid(); 
    } catch(e) {}
    showLoading(false);
}

    async function syncData() {
        try {
            const r = await fetch(`${DB_URL}/users/${state.uid}.json`);
            const d = await r.json();
            if(d) { state = { ...d, inventory: d.inventory ? d.inventory.split(",") : [] }; localStorage.setItem('thunder_user', JSON.stringify(state)); }
        } catch(e) {}
    }

    async function handleAuth(mode) {
        const u = document.getElementById(mode==='login'?'login-user':'reg-user').value.trim();
        const p = document.getElementById(mode==='login'?'login-pass':'reg-pass').value.trim();
        if(!u || !p) return myNotify("Thi·∫øu th√¥ng tin!");
        showLoading(true);
        try {
            const r = await fetch(`${DB_URL}/users.json`);
            const all = await r.json() || {};
            const list = Object.values(all);
            if(mode === 'login') {
                const f = list.find(x => x.name.toLowerCase() === u.toLowerCase() && String(x.password) === String(p));
                if(f) { state = { ...f, inventory: f.inventory ? f.inventory.split(",") : [] }; localStorage.setItem('thunder_user', JSON.stringify(state)); await saveDB(); location.reload(); }
                else myNotify("Sai t√†i kho·∫£n!");
            } else {
                const uid = "TH" + Math.floor(1000 + Math.random() * 8999);
                const newUser = { uid, password: p, name: u, coins: 50, inventory: "", streak: 0, last_claim: "", last_active: new Date().toISOString() };
                await fetch(`${DB_URL}/users/${uid}.json`, { method: 'PUT', body: JSON.stringify(newUser) });
                state = { ...newUser, inventory: [] }; localStorage.setItem('thunder_user', JSON.stringify(state)); location.reload();
            }
        } catch(e) {}
        showLoading(false);
    }

    async function saveDB() {
        if(!state) return;
        state.last_active = new Date().toISOString();
        localStorage.setItem('thunder_user', JSON.stringify(state));
        await fetch(`${DB_URL}/users/${state.uid}.json`, { method: 'PATCH', body: JSON.stringify({ coins: state.coins, inventory: state.inventory.join(","), streak: state.streak, last_claim: state.last_claim, last_active: state.last_active }) });
        updateUI();
    }

    function renderGrid() {
        const grid = document.getElementById('photo-grid');
        grid.innerHTML = "";
        const inv = state ? state.inventory : [];
        const filteredList = currentTab === 'shop' ? IMAGES.filter(i => !inv.includes(i.img_id)) : IMAGES.filter(i => inv.includes(i.img_id));
        const totalPages = Math.ceil(filteredList.length / itemsPerPage) || 1;
        const pageData = filteredList.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

        pageData.forEach(img => {
            const card = document.createElement('div'); card.className = 'photo-card';
            if(currentTab === 'shop') {
                // TRANG CH·ª¶: ·∫¢nh m·ªù + Icon kh√≥a + N√∫t M·ªü kh√≥a
                card.innerHTML = `<div class="photo-wrapper">
                        <img class="img-blur-shop" src="${img.img_url}">
                        <div class="tap-label" style="font-size:20px;">üîí</div>
                    </div>
                    <button class="buy-btn" onclick="buyPhoto('${img.img_id}', ${img.price})">M·ªû KH√ìA ${img.price}ü™ô</button>`;
            } else {
                // KHO ·∫¢NH: ·∫¢nh m·ªù + Ch·∫°m ƒë·ªÉ xem + N√∫t B√°n/T·∫∑ng
                card.innerHTML = `<div class="photo-wrapper" onclick="viewPhoto('${img.img_url}')">
                        <img class="img-blur-inv" src="${img.img_url}">
                        <div class="tap-label">ch·∫°m ƒë·ªÉ xem</div>
                    </div>
                    <div style="display:flex">
                        <button class="buy-btn" style="background:#ff2b4a;flex:1" onclick="confirmSell('${img.img_id}', ${img.price})">B√ÅNü™ô</button>
                        <button class="buy-btn" style="background:#0096ff;flex:1" onclick="giftPhoto('${img.img_id}')">T·∫∂NGüéÅ</button>
                    </div>`;
            }
            grid.appendChild(card);
        });
        document.getElementById('pageInfo').innerText = `Trang ${currentPage} / ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    // --- C√°c h√†m logic kh√°c gi·ªØ nguy√™n 100% ---
    function renderCheckin() { const list = document.getElementById('checkin-list'); list.innerHTML = ""; const now = new Date().toDateString(); const last = state.last_claim ? new Date(state.last_claim).toDateString() : ""; for(let i=1; i<=7; i++) { let statusHtml = (i <= state.streak) ? "ƒë√£ nh·∫≠n ‚úÖ" : (i === state.streak + 1 && now !== last) ? `<button class="btn-action" style="background:var(--green);padding:4px 10px;" onclick="doClaim()">NH·∫¨N</button>` : "üîí"; list.innerHTML += `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee">Ng√†y ${i} <b>${statusHtml}</b></div>`; } openModal('checkinModal'); }
    async function doClaim() { state.streak = (state.streak >= 7) ? 1 : state.streak + 1; state.coins += 2; state.last_claim = new Date().toISOString(); await saveDB(); closeModal('checkinModal'); myNotify("+2 xu th√†nh c√¥ng!"); }
    async function redeemGift() { const code = document.getElementById('gc-input').value.trim(); if(!code) return; showLoading(true); try { const r = await fetch(`${DB_URL}/giftcodes/${code}.json`); const val = await r.json(); if(val) { state.coins += parseInt(val); await saveDB(); await fetch(`${DB_URL}/giftcodes/${code}.json`, { method: 'DELETE' }); closeModal('giftcodeModal'); document.getElementById('rec-uid').innerText = state.uid; document.getElementById('rec-name').innerText = state.name; document.getElementById('rec-date').innerText = new Date().toLocaleString(); document.getElementById('rec-coins').innerText = val; openModal('receiptModal'); } else myNotify("M√£ kh√¥ng h·ª£p l·ªá!"); } catch(e) {} showLoading(false); }
    function changePage(step) { currentPage += step; renderGrid(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function switchTab(t) { currentTab = t; currentPage = 1; document.getElementById('t-shop').className = t==='shop'?'tab-btn active':'tab-btn'; document.getElementById('t-inv').className = t==='inv'?'tab-btn active':'tab-btn'; renderGrid(); }
    function updateUI() { if(!state) return; document.getElementById('u-name').innerText = state.name; document.getElementById('u-uid-small').innerText = "ID: " + state.uid; document.getElementById('u-coins-txt').innerText = "ü™ô " + state.coins; document.getElementById('u-avt').innerText = state.name[0].toUpperCase(); document.getElementById('p-name').innerText = state.name; document.getElementById('p-uid').innerText = "ID: " + state.uid; }
    function showLoading(s) { document.getElementById('loader').style.display = s?'flex':'none'; }
    function checkAuthAndAction(cb) { if(!state) openModal('authModal'); else cb(); }
    function viewPhoto(u) {
    const body = document.getElementById('viewPhotoBody');
    // Ch√®n HTML g·ªìm ·∫¢nh + T·∫•m k√≠nh b·∫£o v·ªá
    body.innerHTML = `
        <div style="position: relative; width: 100%; display: flex; justify-content: center;">
            <img src="${u}" style="width: 100%; border-radius: 8px; display: block;">
            
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; z-index: 10;" 
                 oncontextmenu="return false;"></div>
        </div>
    `;
    // M·ªü c√°i khung Modal to l√™n
    openModal('viewPhotoModal');
}
    
    function logout() { localStorage.removeItem('thunder_user'); location.reload(); }
    async function buyPhoto(id, p) { if(!state) return openModal('authModal'); if(state.coins < p) return myNotify("Kh√¥ng ƒë·ªß xu- n·∫°p th√™m xu ho·∫∑c - ƒëi·ªÉm danh h·∫±ng ng√†y ƒë·ªÉ nh·∫≠n xu !!"); state.coins -= p; state.inventory.push(id); await saveDB(); renderGrid(); myNotify("m·ªü kho√° th√†nh c√¥ng- v√†o kho ƒë·ªÉ xem nh√©!!"); }
    let pendingImgId = null;

// H√†m B√°n ·∫¢nh M·ªõi
function confirmSell(id, p) {
    const rf = Math.floor(p * 0.5);
    document.getElementById('sell-msg').innerHTML = `B·∫°n mu·ªën b√°n ·∫£nh n√†y?<br>S·ªë xu ho√†n l·∫°i: <b style="color:var(--green)">+${rf} ü™ô</b>`;
    
    document.getElementById('btn-confirm-final').onclick = async function() {
        showLoading(true);
        state.coins += rf;
        state.inventory = state.inventory.filter(i => i !== id);
        await saveDB();
        renderGrid();
        closeModal('confirmSellModal');
        showLoading(false);
        myNotify("B√°n th√†nh c√¥ng, ƒë√£ c·ªông " + rf + " xu!");
    };
    openModal('confirmSellModal');
}

// H√†m G·ª≠i ·∫¢nh M·ªõi
function giftPhoto(imgId) {
    pendingImgId = imgId;
    document.getElementById('gift-tid').value = ""; // X√≥a tr·∫Øng √¥ nh·∫≠p
    
    document.getElementById('btn-gift-final').onclick = async function() {
        const tid = document.getElementById('gift-tid').value.trim().toUpperCase();
        if(!tid) return myNotify("Vui l√≤ng nh·∫≠p ID!");
        if(tid === state.uid) return myNotify("Kh√¥ng th·ªÉ t·ª± t·∫∑ng cho m√¨nh!");

        showLoading(true);
        try {
            const r = await fetch(`${DB_URL}/users/${tid}.json`);
            const u = await r.json();
            if(u) {
                let inv = u.inventory ? u.inventory.split(",") : [];
                if(inv.includes(pendingImgId)) {
                    showLoading(false);
                    return myNotify("Ng∆∞·ªùi n√†y ƒë√£ c√≥ ·∫£nh n√†y r·ªìi!");
                }
                inv.push(pendingImgId);
                await fetch(`${DB_URL}/users/${tid}.json`, { 
                    method: 'PATCH', 
                    body: JSON.stringify({ inventory: inv.join(",") }) 
                });
                
                state.inventory = state.inventory.filter(i => i !== pendingImgId);
                await saveDB();
                renderGrid();
                closeModal('giftModal');
                myNotify("ƒê√£ g·ª≠i qu√† th√†nh c√¥ng cho" + tid);
            } else {
                myNotify("ID ng∆∞·ªùi nh·∫≠n kh√¥ng t·ªìn t·∫°i!");
            }
        } catch(e) {
            myNotify("L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i!");
        }
        showLoading(false);
    };
    openModal('giftModal');
}

    init();
    function preloadImages(photoArray) {
    photoArray.forEach(p => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'image';
        link.href = p.url;
        document.head.appendChild(link);
    });
}

// G·ªçi h√†m n√†y sau khi d·ªØ li·ªáu ·∫£nh ƒë√£ t·∫£i xong t·ª´ Firebase
// V√≠ d·ª•: trong h√†m loadData, sau khi c√≥ m·∫£ng photos
// preloadImages(photos); 

</script>
</body>
</html>